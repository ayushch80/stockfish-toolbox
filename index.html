<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<link rel="icon" type="image/svg+xml" href="/vite.svg" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Stockfish Toolbox</title>
		<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css"> -->
		<link rel="stylesheet" type="text/css" href="/bulma.css">
	</head>
	<body>
		<div id="app" class="theme-dark">
			<div class="">
				<center><h1 class="title is-2 box">Stockfish Toolbox</h1></center>
			</div>
			<div class="error" style="position: absolute;width: 100%;z-index: 4;"></div>
			<section class="section">
				<div class="box is-flex is-flex-wrap-nowrap">
					<a class="button mr-auto" href="#home" onclick="showPage('#home')"> Home </a>
					<a class="button mr-auto" href="#cli" onclick="showPage('#cli')"> CLI </a>
					<a class="button mr-auto" href="#benchmark" onclick="showPage('#benchmark')"> Benchmark </a>
					<a class="button mr-auto" href="#insights" onclick="showPage('#insights')"> Insights </a>
				</div>
			</section>
			<div class="home">
				<section class="section">
					<div class="is-flex is-flex-direction-column is-align-content-center">

						<div class="field">
							<label class="label">Stockfish Version</label>
							<div class="control">
								<div class="select">
									<select disabled>
										<option>Stockfish NNUE 16</option>
									</select>
								</div>
							</div>
						</div>

						<div class="is-flex">

							<div class="field px-1">
								<label class="label">FEN</label>
								<div class="control">
									<input class="input fen-input" type="text" value="r3kbnr/pp1b1ppp/2Pp1q2/1B6/Q3P3/8/PPP2PPP/RNB1K2R b - - 0 1" placeholder="FEN">
								</div>
							</div>

							<div class="field">
								<label class="label">Depth</label>
								<div class="control">
									<input class="input depth-input" type="number" value="5" placeholder="Depth">
								</div>
							</div>

							<div class="field">
								<label class="label">Threads</label>
								<div class="control">
									<input class="input thread-input" type="number" value="1" placeholder="Threads">
								</div>
							</div>

						</div>

						<button class="button is-info">NEXT MOVE !!</button>

					</div>
				</section>
				<section class="section title is-4">
					<p class="bestmove">Best Move: None</p>
					<p class="pondermove">Ponder Move: None</p>
				</section>
				<div class="mx-5">
					<p> Generated in <p class="time-taken">0.00s</p> </p>
				</div>
			</div>
			<div class="cli">
				<section class="section">
					<h1> STOCKFISH CLI </h1>
					<div class="field block">
						<label class="label">COMMAND:</label>
						<div class="control block">
							<input class="input command-input" type="text" value="uci" placeholder="Enter Stockfish Command Here">
						</div>
						<button class="button block" onclick="executeStockfishCommand()">EXECUTE</button>
						<button class="button block" onclick="clearOutput()">Clear Output</button>
					</div>
					<div class="block">
						Output :
						<div class="output">
							
						</div>
					</div>
				</section>
			</div>

			<div class="benchmark">
				BENCHMARK (coming soon)
			</div>

			<div class="insights">
				INSIGHTS (coming soon)
			</div>

		</div>
		<script src="/stockfish/stockfish.js"></script>
		<script>
			function showPage (page /* "#home" "#cli" "#benchmark" "#insights" */) {
				if (page === "#home") {
					document.querySelector(".home").hidden = false
					document.querySelector(".cli").hidden = true
					document.querySelector(".benchmark").hidden = true
					document.querySelector(".insights").hidden = true
				} else if (page === "#cli") {
					document.querySelector(".home").hidden = true
					document.querySelector(".cli").hidden = false
					document.querySelector(".benchmark").hidden = true
					document.querySelector(".insights").hidden = true
				} else if (page === "#benchmark") {
					document.querySelector(".home").hidden = true
					document.querySelector(".cli").hidden = true
					document.querySelector(".benchmark").hidden = false
					document.querySelector(".insights").hidden = true
				} else if (page === "#insights") {
					document.querySelector(".home").hidden = true
					document.querySelector(".cli").hidden = true
					document.querySelector(".benchmark").hidden = true
					document.querySelector(".insights").hidden = false
				} else {
					showPage("#home")
				}
			}
		</script>
		<script type="text/javascript">
			var index = 0
			function removeAllError () {
				document.querySelector(".error").innerHTML = ""
			}
			function removeErrorByClass (className) {
				console.log(className)
				document.querySelector(className).remove()
			}
			function addNewError (message) {
				document.querySelector(".error").innerHTML = `	<div class="notification is-danger m-4 error-${index}">
																	<button class="delete" onclick="removeErrorByClass('.error-${index}')"></button>
																	[${index+1}] ${message}
																</div>` + document.querySelector(".error").innerHTML

				index++
			}
		</script>
		<script type="text/javascript">
			function wasmThreadsSupported() {
				// WebAssembly 1.0
				const source = Uint8Array.of(0x0, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00);
				if (
					typeof WebAssembly !== "object" ||
					typeof WebAssembly.validate !== "function"
				)
					return false;
				if (!WebAssembly.validate(source)) return false;

				// SharedArrayBuffer
				if (typeof SharedArrayBuffer !== "function") return false;

				// Atomics
				if (typeof Atomics !== "object") return false;

				// Shared memory
				const mem = new WebAssembly.Memory({ shared: true, initial: 8, maximum: 16 });
				if (!(mem.buffer instanceof SharedArrayBuffer)) return false;

				// Structured cloning
				try {
					// You have to make sure nobody cares about these messages!
					window.postMessage(mem, "*");
				} catch (e) {
					return false;
				}

				// Growable shared memory (optional)
				try {
					mem.grow(8);
				} catch (e) {
					return false;
				}

				return true;
			}

			console.log("wasmThreadsSupported",wasmThreadsSupported())
		</script>
		<script type="text/javascript">
			function executeStockfishCommand () {
				if (wasmThreadsSupported()) {
					var command = document.querySelector(".command-input").value
					execute(command)
				} else {
					addNewError("WASM Threads are not supported, please contact administrator of the website")
				}
			}

			function execute (command) {
				Stockfish().then((sf) => {
					sf.addMessageListener((line) => {
						//console.log(line)
						document.querySelector(".output").innerHTML += `<p>${line}</p>`
					})
					sf.postMessage(command);
					sf.terminate()
				})
			}

			function clearOutput () {
				document.querySelector(".output").innerHTML = ""
			}
		</script>
		<script type="module" src="/main.js"></script>
	</body>
</html>
